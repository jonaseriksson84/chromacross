---
import GameGrid from '../components/GameGrid.astro';
import ColorPalette from '../components/ColorPalette.astro';
import VirtualKeyboard from '../components/VirtualKeyboard.astro';
import GameModals from '../components/GameModals.astro';

// A hardcoded puzzle for development
const puzzle = {
	puzzleId: 1,
	words: { horizontal: "WATER", vertical: "LEMON" },
	intersection: { letter: "E", horizontalIndex: 3, verticalIndex: 1 },
	uniqueLetters: ["W", "A", "T", "E", "R", "L", "M", "O", "N"],
	colorMap: {
		W: "#4a90e2",
		A: "#7ed321",
		T: "#f5a623",
		E: "#bd10e0",
		R: "#d0021b",
		L: "#f8e71c",
		M: "#50e3c2",
		O: "#9013fe",
		N: "#b8e986",
	},
};

// The player's current state
const gameState = {
	puzzleId: 1,
	revealedLetters: [],
	incorrectGuesses: [],
	status: "IN_PROGRESS",
};
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>ChromaCross</title>
	</head>
	<body>
		<div id="game-container">
			<header>
				<h1>ChromaCross</h1>
			</header>

			<div id="game-info">
				<div id="guess-counter">
					Remaining guesses: <span id="remaining-count">6</span>
				</div>
			</div>

			<GameGrid puzzle={puzzle} gameState={gameState} />
			<ColorPalette puzzle={puzzle} gameState={gameState} />
			<VirtualKeyboard gameState={gameState} />
			<GameModals />
		</div>

		<script>
			import { 
				handleGuess, 
				saveState, 
				loadState, 
				render, 
				shakeElement 
			} from '../utils/gameLogic.js';
			import { addShareEventListeners } from '../utils/shareUtils.js';

			// Pass server-side data to client-side
			const puzzle = {
				puzzleId: 1,
				words: { horizontal: "WATER", vertical: "LEMON" },
				intersection: { letter: "E", horizontalIndex: 3, verticalIndex: 1 },
				uniqueLetters: ["W", "A", "T", "E", "R", "L", "M", "O", "N"],
				colorMap: {
					W: "#4a90e2",
					A: "#7ed321",
					T: "#f5a623",
					E: "#bd10e0",
					R: "#d0021b",
					L: "#f8e71c",
					M: "#50e3c2",
					O: "#9013fe",
					N: "#b8e986",
				},
			};

			// The player's current state (will be reactive)
			let gameState = {
				puzzleId: 1,
				revealedLetters: [],
				incorrectGuesses: [],
				status: "IN_PROGRESS",
			};

			// Add event listeners when DOM is loaded
			document.addEventListener("DOMContentLoaded", function () {
				// Load saved state before initializing
				const savedState = loadState(puzzle.puzzleId);
				if (savedState) {
					gameState = savedState;
					console.log("Game state loaded:", gameState);
				}

				addEventListeners();
				addShareEventListeners(puzzle, gameState);
				// Initial render to replace server-side content with client-side interactive version
				render(puzzle, gameState);
			});

			function addEventListeners(): void {
				// Event delegation for keyboard clicks
				const keyboardContainer = document.getElementById("keyboard-container");
				if (keyboardContainer) {
					keyboardContainer.addEventListener("click", function (event: Event) {
						const target = event.target as HTMLElement;
						if (target.classList.contains("key")) {
							const letter = (target as HTMLButtonElement).dataset.letter;
							if (letter) {
								handleGuessWrapper(letter);
							}
						}
					});
				}

				// Optional: Add physical keyboard support
				document.addEventListener("keydown", function (event: KeyboardEvent) {
					const letter = event.key.toUpperCase();
					if (letter.match(/[A-Z]/)) {
						handleGuessWrapper(letter);
					}
				});
			}

			function handleGuessWrapper(letter: string): void {
				const result = handleGuess(letter, puzzle, gameState);
				
				if (result.shouldShake) {
					// Provide feedback (brief shake or highlight)
					shakeElement(document.querySelector(`[data-letter="${letter}"]`));
					return;
				}

				// Update game state
				gameState = result.gameState;

				// Save state after every valid move
				saveState(gameState);

				// Re-render the UI
				render(puzzle, gameState);

				// Update share event listeners with new game state
				addShareEventListeners(puzzle, gameState);
			}
		</script>
	</body>
</html>

<style>
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	body {
		font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
			Ubuntu, Cantarell, sans-serif;
		background-color: #1a1a1a;
		color: #ffffff;
		min-height: 100vh;
		display: flex;
		justify-content: center;
		align-items: center;
		padding: 20px;
	}

	#game-container {
		max-width: 500px;
		width: 100%;
		display: flex;
		flex-direction: column;
		gap: 2rem;
		text-align: center;
	}

	header h1 {
		font-size: 2.5rem;
		font-weight: bold;
		margin-bottom: 1rem;
		background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
	}

	#game-info {
		text-align: center;
		margin-bottom: 1rem;
		font-size: 1.1rem;
	}

	#guess-counter {
		background-color: #2a2a2a;
		border: 2px solid #3a3a3a;
		border-radius: 8px;
		padding: 0.75rem 1rem;
		display: inline-block;
	}

	#remaining-count {
		font-weight: bold;
		color: #4ecdc4;
	}

	#remaining-count.warning {
		color: #ff6b6b;
	}

	@keyframes shake {
		0%,
		100% {
			transform: translateX(0);
		}
		25% {
			transform: translateX(-5px);
		}
		75% {
			transform: translateX(5px);
		}
	}

	@media (max-width: 600px) {
		#game-container {
			max-width: 100%;
			gap: 1.5rem;
		}

		header h1 {
			font-size: 2rem;
		}
	}
</style>